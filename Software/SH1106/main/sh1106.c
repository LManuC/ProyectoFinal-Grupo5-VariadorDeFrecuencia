#include "esp_err.h"
#include "sh1106.h"
#include <string.h>
#include "sh1106_i2c.h"
#include "driver/i2c.h"

#define I2C_MASTER_NUM      I2C_NUM_0
#define I2C_MASTER_SDA_IO   21       // GPIO21 -> SDA
#define I2C_MASTER_SCL_IO   22       // GPIO22 -> SCL
#define I2C_MASTER_FREQ_HZ  400000   // 400kHz
#define I2C_MASTER_TX_BUF_DISABLE 0
#define I2C_MASTER_RX_BUF_DISABLE 0

static const unsigned char logo16_utn_bmp[] =
{ 0b01110001, 0b10001110,
  0b01110001, 0b10001110,
  0b01111001, 0b10011110,
  0b00111101, 0b10111100,
  0b00011111, 0b11111000,
  0b00000111, 0b11100000,
  0b00000111, 0b11100000,
  0b00011111, 0b11111000,
  0b00111101, 0b10111100,
  0b01111001, 0b10011110,
  0b01110001, 0b10001110,
  0b01110001, 0b10001110
};
static const unsigned char fail_bmp[] =
{ 0b00000011, 0b11000000,
  0b00001100, 0b00110000,
  0b00110011, 0b11011000,
  0b01101110, 0b01101100,
  0b11011100, 0b00000110,
  0b11011110, 0b00000011,
  0b11001111, 0b11100011,
  0b11000111, 0b11110011,
  0b11000000, 0b01111011,
  0b01100000, 0b01110110,
  0b00110110, 0b01101100,
  0b00011011, 0b11011000,
  0b00001100, 0b00110000,
  0b00000011, 0b11000000 
};


/*
static const unsigned char warning_bmp[] =
{ 0b00000001, 0b10000000,
  0b00000011, 0b11000000,
  0b00000011, 0b11000000,
  0b00000011, 0b11000000,
  0b00000011, 0b11000000,
  0b00000011, 0b11000000,
  0b00000011, 0b11000000,
  0b00000011, 0b11000000,
  0b00000001, 0b10000000,
  0b00000000, 0b00000000,
  0b00000001, 0b10000000,
  0b00000011, 0b11000000,
  0b00000011, 0b11000000,
  0b00000001, 0b10000000
};
*/

static const unsigned char line_bmp[] =
{ 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};

static const unsigned char arrow_bmp[] =
{ 0b00000000, 0b00100000,
  0b00000000, 0b00110000,
  0b00000000, 0b00111000,
  0b00011111, 0b11111100,
  0b00000000, 0b00111000,
  0b00000000, 0b00110000,
  0b00000000, 0b00100000
};

const uint8_t font5x7_space[7] =        {0x00,0x00,0x00,0x00,0x00,0x00,0x00};
const uint8_t font5x7_double_dot[7] =   {0x18,0x18,0x00,0x00,0x18,0x18,0x00};
const uint8_t font5x7_dot[7] =          {0x00,0x00,0x00,0x00,0x00,0x18,0x18};
const uint8_t font5x7_comma[7] =        {0x00,0x00,0x00,0x00,0x18,0x18,0x30};
const uint8_t font5x7_open_quest[7] =   {0x18,0x00,0x18,0x30,0x60,0x66,0x3C};
const uint8_t font5x7_close_quest[7] =  {0x3C,0x66,0x06,0x0C,0x18,0x00,0x18};
const uint8_t font5x7_open_excl[7] =    {0x18,0x00,0x18,0x18,0x18,0x18,0x18};
const uint8_t font5x7_close_excl[7] =   {0x18,0x18,0x18,0x18,0x18,0x00,0x18};
const uint8_t font5x7_minus[7] =        {0x00,0x00,0x00,0x7E,0x00,0x00,0x00};

const uint8_t font5x7_rowmajor[][7] = {
    // A-Z
    {0x1E,0x33,0x33,0x3F,0x33,0x33,0x33},
    {0x3E,0x33,0x33,0x3E,0x33,0x33,0x3E},
    {0x1E,0x33,0x30,0x30,0x30,0x33,0x1E},
    {0x3C,0x36,0x33,0x33,0x33,0x36,0x3C},
    {0x3F,0x30,0x30,0x3E,0x30,0x30,0x3F},
    {0x3F,0x30,0x30,0x3E,0x30,0x30,0x30},
    {0x1E,0x33,0x30,0x37,0x33,0x33,0x1F},
    {0x33,0x33,0x33,0x3F,0x33,0x33,0x33},
    {0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0x1E},
    {0x0F,0x06,0x06,0x06,0x06,0x36,0x1C},
    {0x33,0x36,0x3C,0x38,0x3C,0x36,0x33},
    {0x30,0x30,0x30,0x30,0x30,0x30,0x3F},
    {0x33,0x3F,0x3F,0x33,0x33,0x33,0x33},
    {0x33,0x3B,0x3F,0x37,0x33,0x33,0x33},
    {0x1E,0x33,0x33,0x33,0x33,0x33,0x1E},
    {0x3E,0x33,0x33,0x3E,0x30,0x30,0x30},
    {0x1E,0x33,0x33,0x33,0x37,0x36,0x1D},
    {0x3E,0x33,0x33,0x3E,0x3C,0x36,0x33},
    {0x1E,0x33,0x30,0x1E,0x03,0x33,0x1E},
    {0x3F,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C},
    {0x33,0x33,0x33,0x33,0x33,0x33,0x1E},
    {0x33,0x33,0x33,0x33,0x33,0x1E,0x0C},
    {0x33,0x33,0x33,0x33,0x3F,0x3F,0x33},
    {0x33,0x33,0x1E,0x0C,0x1E,0x33,0x33},
    {0x33,0x33,0x33,0x1E,0x0C,0x0C,0x0C},
    {0x3F,0x03,0x06,0x0C,0x18,0x30,0x3F}
};

const uint8_t font5x7_rowminor[][7] = {
    {0x00,0x00,0x3C,0x06,0x3E,0x66,0x3E},
    {0x60,0x60,0x7C,0x66,0x66,0x66,0x7C},
    {0x00,0x00,0x3C,0x66,0x60,0x66,0x3C},
    {0x06,0x06,0x3E,0x66,0x66,0x66,0x3E},
    {0x00,0x00,0x3C,0x66,0x7E,0x60,0x3C},
    {0x1C,0x30,0x30,0x7C,0x30,0x30,0x30},
    {0x00,0x3E,0x66,0x66,0x3E,0x06,0x7C},
    {0x60,0x60,0x7C,0x66,0x66,0x66,0x66},
    {0x18,0x00,0x38,0x18,0x18,0x18,0x3C},
    {0x06,0x00,0x06,0x06,0x66,0x66,0x3C},
    {0x60,0x60,0x66,0x6C,0x78,0x6C,0x66},
    {0x38,0x18,0x18,0x18,0x18,0x18,0x3C},
    {0x00,0x00,0x6C,0x7E,0x7E,0x6C,0x6C},
    {0x00,0x00,0x7C,0x66,0x66,0x66,0x66},
    {0x00,0x00,0x3C,0x66,0x66,0x66,0x3C},
    {0x00,0x7C,0x66,0x66,0x7C,0x60,0x60},
    {0x00,0x3E,0x66,0x66,0x3E,0x06,0x06},
    {0x00,0x00,0x6C,0x76,0x60,0x60,0x60},
    {0x00,0x00,0x3E,0x60,0x3C,0x06,0x7C},
    {0x30,0x30,0x7C,0x30,0x30,0x30,0x1C},
    {0x00,0x00,0x66,0x66,0x66,0x66,0x3E},
    {0x00,0x00,0x66,0x66,0x66,0x3C,0x18},
    {0x00,0x00,0x66,0x66,0x7E,0x7E,0x6C},
    {0x00,0x00,0x66,0x3C,0x18,0x3C,0x66},
    {0x00,0x66,0x66,0x66,0x3E,0x06,0x7C},
    {0x00,0x7E,0x0C,0x18,0x30,0x7E,0x00}
};

const uint8_t font5x7_rownumber[][7] = {
    {0x1E,0x33,0x37,0x3B,0x33,0x33,0x1E},
    {0x0C,0x1C,0x0C,0x0C,0x0C,0x0C,0x1E},
    {0x1E,0x33,0x03,0x0E,0x18,0x30,0x3F},
    {0x1E,0x33,0x03,0x0E,0x03,0x33,0x1E},
    {0x06,0x0E,0x1E,0x36,0x3F,0x06,0x06},
    {0x3F,0x30,0x3E,0x03,0x03,0x33,0x1E},
    {0x1E,0x30,0x3E,0x33,0x33,0x33,0x1E},
    {0x3F,0x03,0x06,0x0C,0x18,0x18,0x18},
    {0x1E,0x33,0x33,0x1E,0x33,0x33,0x1E},
    {0x1E,0x33,0x33,0x1F,0x03,0x03,0x1E}
};

const uint8_t font8x14_double_dot[14] =   {0x00,0x38,0x38,0x38,0x00,0x00,0x00,0x00,0x00,0x38,0x38,0x38,0x00,0x00};
const uint8_t font8x14_rownumber[][14] = {
    {0x3C,0x66,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0x66,0x3C,0x00},
    {0x18,0x38,0x78,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00},
    {0x3C,0x66,0xC3,0x03,0x06,0x0C,0x18,0x30,0x60,0xC0,0xC3,0xFF,0xFE,0x00},
    {0x7E,0xC3,0x03,0x03,0x06,0x3C,0x06,0x03,0x03,0x03,0xC3,0x66,0x3C,0x00},
    {0x06,0x0E,0x1E,0x36,0x66,0xC6,0x86,0xFF,0xFF,0x06,0x06,0x06,0x06,0x00},
    {0xFE,0xC0,0xC0,0xC0,0xFC,0xC6,0x03,0x03,0x03,0x03,0xC3,0x66,0x3C,0x00},
    {0x3C,0x66,0xC3,0xC0,0xC0,0xFC,0xC6,0xC3,0xC3,0xC3,0xC3,0x66,0x3C,0x00},
    {0xFF,0xC3,0x03,0x06,0x06,0x0C,0x18,0x18,0x30,0x30,0x60,0x60,0x60,0x00},
    {0x3C,0x66,0xC3,0xC3,0xC3,0x66,0x3C,0x66,0xC3,0xC3,0xC3,0x66,0x3C,0x00},
    {0x3C,0x66,0xC3,0xC3,0xC3,0x67,0x3F,0x03,0x03,0x03,0xC3,0x66,0x3C,0x00}
};

static void i2c_master_init(void)
{
    i2c_config_t conf = {
        .mode = I2C_MODE_MASTER,
        .sda_io_num = I2C_MASTER_SDA_IO,
        .sda_pullup_en = GPIO_PULLUP_ENABLE,
        .scl_io_num = I2C_MASTER_SCL_IO,
        .scl_pullup_en = GPIO_PULLUP_ENABLE,
        .master.clk_speed = I2C_MASTER_FREQ_HZ,
    };
    ESP_ERROR_CHECK(i2c_param_config(I2C_MASTER_NUM, &conf));
    ESP_ERROR_CHECK(i2c_driver_install(I2C_MASTER_NUM,
                                       conf.mode,
                                       I2C_MASTER_RX_BUF_DISABLE,
                                       I2C_MASTER_TX_BUF_DISABLE, 0));
}
// Secuencia de inicialización del SH1106 (simplificada)
// Basada en la hoja de datos
static const uint8_t init_seq[] = {
    0xAE,  // DISPLAYOFF
    0xD5,  // SETDISPLAYCLOCKDIV
    0x80,
    0xA8,  // SETMULTIPLEX
    0x3F,
    0xD3,  // SETDISPLAYOFFSET
    0x00,
    0x40,  // SETSTARTLINE
    0xAD,  // SETCHARGEPUMP
    0x8B,
    0xA1,  // SEGREMAP
    0xC8,  // COMSCANDEC
    0xDA,  // SETCOMPINS
    0x12,
    0x81,  // SETCONTRAST
    0xCF,
    0xD9,  // SETPRECHARGE
    0xF1,
    0xDB,  // SETVCOMDETECT
    0x40,
    0xA4,  // DISPLAYALLON_RESUME
    0xA6,  // NORMALDISPLAY
    0xAF   // DISPLAYON
};

esp_err_t sh1106_init(sh1106_t *oled) {
    i2c_master_init();
    for (size_t i = 0; i < sizeof(init_seq); i++) {
        ESP_ERROR_CHECK(sh1106_write_command(init_seq[i]));
    }
    sh1106_clear_buffer(oled);
    return sh1106_refresh(oled);
}

void sh1106_clear_buffer(sh1106_t *oled) {
    memset(oled->buffer, 0, sizeof(oled->buffer));
}

esp_err_t sh1106_refresh(sh1106_t *oled) {
    // El SH1106 espera que se setee la dirección de la columna
    // luego se manden datos página por página
    for (uint8_t page = 0; page < 8; page++) {
        // Dirección de página
        ESP_ERROR_CHECK(sh1106_write_command(0xB0 + page));

        // Dirección de columna baja y alta (offset 2 que ajusta SH1106)
        ESP_ERROR_CHECK(sh1106_write_command(0x02));    // col lo (2)
        ESP_ERROR_CHECK(sh1106_write_command(0x10));    // col hi

        // Enviar 128 bytes de datos para esta página
        uint8_t *page_data = &oled->buffer[page * 128];
        ESP_ERROR_CHECK(sh1106_write_data(page_data, 128));
    }
    return ESP_OK;
}

void sh1106_draw_bitmap(sh1106_t *oled, const uint8_t *bitmap, uint8_t w, uint8_t h, int x, int y) {
    // Dibujado sencillo: copia bit por bit en el buffer
    // (Implementar según formato del bitmap)
    for (uint8_t by = 0; by < h; by++) {
        for (uint8_t bx = 0; bx < w; bx++) {
            uint8_t byte = bitmap[by * ((w + 7) / 8) + (bx / 8)];
            uint8_t bit = (byte >> (7 - (bx % 8))) & 0x01;
            if (bit) {
                int px = x + bx;
                int py = y + by;
                if (px >= 0 && px < oled->width && py >= 0 && py < oled->height) {
                    uint8_t page = py / 8;
                    uint8_t bitpos = py % 8;
                    oled->buffer[page * oled->width + px] |= (1 << bitpos);
                }
            }
        }
    }
}

void sh1106_draw_text(sh1106_t *oled, const char *text, int x, int y) {
    uint8_t y_diff = 0;
    for(uint8_t x_diff = 0, letter = 0; letter < strlen(text); x_diff++, letter++) {
        if (x + 8 * x_diff > 120) {
            x_diff = 0;
            y_diff += 9;
        }
        if ( text[letter] >= 'A' && text[letter] <= 'Z') {
            sh1106_draw_bitmap(oled, font5x7_rowmajor[text[letter] - 'A'],8, 7, x + 8 * x_diff, y + y_diff);
        } else if ( text[letter] >= 'a' && text[letter] <= 'z') {
            sh1106_draw_bitmap(oled, font5x7_rowminor[text[letter] - 'a'],8, 7, x + 8 * x_diff, y + y_diff);
        } else if ( text[letter] >= '0' && text[letter] <= '9') {
            sh1106_draw_bitmap(oled, font5x7_rownumber[text[letter] - '0'],8, 7, x + 8 * x_diff, y + y_diff);
        } else if ( text[letter] == ' ') {
            sh1106_draw_bitmap(oled, font5x7_space,8, 7, x + 8 * x_diff, y + y_diff);
        } else if ( text[letter] == ':') {
            sh1106_draw_bitmap(oled, font5x7_double_dot,8, 7, x + 8 * x_diff, y + y_diff);
        } else if ( text[letter] == '.') {
            sh1106_draw_bitmap(oled, font5x7_dot,8, 7, x + 8 * x_diff, y + y_diff);
        } else if ( text[letter] == ',') {
            sh1106_draw_bitmap(oled, font5x7_comma,8, 7, x + 8 * x_diff, y + y_diff);
        } else if ( text[letter] == '?') {
            sh1106_draw_bitmap(oled, font5x7_close_quest,8, 7, x + 8 * x_diff, y + y_diff);
        } else if ( text[letter] == '!') {
            sh1106_draw_bitmap(oled, font5x7_close_excl,8, 7, x + 8 * x_diff, y + y_diff);
        } else if ( text[letter] == '-') {
            sh1106_draw_bitmap(oled, font5x7_minus,8, 7, x + 8 * x_diff, y + y_diff);
        }
    }
}

void sh1106_draw_number(sh1106_t *oled, uint16_t value, int x, int y, uint8_t dots) {
    uint8_t y_diff = 0;
    char text[6];
    sprintf(text, "%d", value);

    for(uint8_t x_diff = 0, letter = 0; letter < strlen(text); x_diff++, letter++) {
        if (x + 8 * x_diff > 120) {
            x_diff = 0;
            y_diff += 9;
        }
        if ( text[letter] >= '0' && text[letter] <= '9') {
            sh1106_draw_bitmap(oled, font5x7_rownumber[text[letter] - '0'],8, 7, x + 8 * x_diff, y + y_diff);
        } else if ( text[letter] == ':') {
            sh1106_draw_bitmap(oled, font5x7_double_dot,8, 7, x + 8 * x_diff, y + y_diff);
        }
    }
}

void sh1106_print_hour(sh1106_t *oled, const char *text) {
    uint8_t x = 28;
    uint8_t y = 0;
    uint8_t y_diff = 0;
    for(uint8_t x_diff = 0, letter = 0; letter < strlen(text); x_diff++, letter++) {
        if (x + 8 * x_diff > 120) {
            x_diff = 0;
            y_diff += 9;
        }
        if ( text[letter] >= '0' && text[letter] <= '9') {
            sh1106_draw_bitmap(oled, font8x14_rownumber[text[letter] - '0'],8, 14, x + 9 * x_diff, y + y_diff);
        } else if ( text[letter] == ':') {
            sh1106_draw_bitmap(oled, font8x14_double_dot,8, 14, x + 9 * x_diff, y + y_diff);
        }
    }
    // Implementación simple: dibuja caracteres monoespaciados a partir
    // de una tabla de fuente bitmap. Aquí usaríamos tu método de fuente,
    // o una tabla que definas externamente.
}

void sh1106_draw_utn_logo(sh1106_t *oled, int x, int y) {
    sh1106_draw_bitmap(oled, logo16_utn_bmp, 16, 12, x, y);
}

void sh1106_draw_arrow(sh1106_t *oled, int x, int y) {
    sh1106_draw_bitmap(oled, arrow_bmp, 16, 7, x, y);

}

void sh1106_draw_fail(sh1106_t *oled, int x, int y) {
    sh1106_draw_bitmap(oled, fail_bmp, 16, 14, x, y);

}

void sh1106_draw_line(sh1106_t *oled, int x, int y) {
    sh1106_draw_bitmap(oled, line_bmp,128, 1, x, y);
}