\doxysection{Referencia del archivo C\+:/\+Users/\+User/\+Desktop/\+Proyecto\+Final-\/\+Grupo5-\/\+Variador\+De\+Frecuencia/\+Software/\+Firmware stm32/\+Modules/\+SPI\+\_\+\+Interfase/\+SPIModule.c}
\hypertarget{_s_p_i_module_8c}{}\label{_s_p_i_module_8c}\index{C:/Users/User/Desktop/ProyectoFinal-\/Grupo5-\/VariadorDeFrecuencia/Software/Firmware stm32/Modules/SPI\_Interfase/SPIModule.c@{C:/Users/User/Desktop/ProyectoFinal-\/Grupo5-\/VariadorDeFrecuencia/Software/Firmware stm32/Modules/SPI\_Interfase/SPIModule.c}}
{\ttfamily \#include $<$stdio.\+h$>$}\newline
{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include "{}main.\+h"{}}\newline
{\ttfamily \#include "{}../\+Gestor\+\_\+\+Estados/\+Gestor\+Estados.\+h"{}}\newline
Gráfico de dependencias incluidas en SPIModule.\+c\+:
% FIG 0
\doxysubsubsection*{defines}
\begin{DoxyCompactItemize}
\item 
\#define \mbox{\hyperlink{_s_p_i_module_8c_a58ae1be1f69cd7b7a0643a2bb826fc7c}{SPI\+\_\+\+BUF\+\_\+\+SIZE}}~16
\item 
\#define \mbox{\hyperlink{_s_p_i_module_8c_a59d33135764e7772f86c6d0312592d56}{SPI\+\_\+\+TRANSMITION\+\_\+\+SIZE}}~4
\item 
\#define \mbox{\hyperlink{_s_p_i_module_8c_ac5c85a6a18b2073865149b2c0554ce8d}{CMD\+\_\+\+LEN}}~3
\end{DoxyCompactItemize}
\doxysubsubsection*{Funciones}
\begin{DoxyCompactItemize}
\item 
static void \mbox{\hyperlink{_s_p_i_module_8c_ad1d9e4b748a3033ce47c0453db513e41}{SPI\+\_\+\+Procesar\+Comando}} (uint8\+\_\+t \texorpdfstring{$\ast$}{*}buffer, int cant\+Bytes, uint8\+\_\+t \texorpdfstring{$\ast$}{*}buffer\+Response)
\begin{DoxyCompactList}\small\item\em Procesa un comando recibido por SPI y construye la respuesta. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{_s_p_i_module_8c_a2762f45ff67d3812619ca1b63c255140}{HAL\+\_\+\+SPI\+\_\+\+Tx\+Rx\+Cplt\+Callback}} (SPI\+\_\+\+Handle\+Type\+Def \texorpdfstring{$\ast$}{*}\+\_\+hspi)
\begin{DoxyCompactList}\small\item\em Callback de HAL llamado al completar una transacción Tx\+Rx por DMA. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{_s_p_i_module_8c_aceba80d82f5ac1327eac27d5a8261885}{SPI\+\_\+\+Init}} (void \texorpdfstring{$\ast$}{*}\+\_\+hspi)
\begin{DoxyCompactList}\small\item\em Inicializa el módulo SPI esclavo con DMA y deja activa la primera transacción. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
uint8\+\_\+t \mbox{\hyperlink{_s_p_i_module_8c_ab3d82dfa3d2a6af7b144935391b4ff34}{rx\+DMABuffer}} \mbox{[}\mbox{\hyperlink{_s_p_i_module_8c_a58ae1be1f69cd7b7a0643a2bb826fc7c}{SPI\+\_\+\+BUF\+\_\+\+SIZE}}\mbox{]}
\item 
uint8\+\_\+t \mbox{\hyperlink{_s_p_i_module_8c_a6f050568ae6cfe8a5b1c4a139e78e66b}{tx\+DMABuffer}} \mbox{[}\mbox{\hyperlink{_s_p_i_module_8c_a58ae1be1f69cd7b7a0643a2bb826fc7c}{SPI\+\_\+\+BUF\+\_\+\+SIZE}}\mbox{]}
\item 
volatile uint8\+\_\+t \mbox{\hyperlink{_s_p_i_module_8c_a0d2daeae9d2a4a1f3a1580552e640ff3}{rx\+Buffer}} \mbox{[}\mbox{\hyperlink{_s_p_i_module_8c_a58ae1be1f69cd7b7a0643a2bb826fc7c}{SPI\+\_\+\+BUF\+\_\+\+SIZE}}\mbox{]}
\item 
volatile int \mbox{\hyperlink{_s_p_i_module_8c_a92c8fb020dce18b7572691d5ffdd0f76}{rx\+Index}} = 0
\item 
volatile uint8\+\_\+t \mbox{\hyperlink{_s_p_i_module_8c_a7f54dbc4c9079015d2acd620d6b4bf82}{tx\+\_\+buffer}} \mbox{[}\mbox{\hyperlink{_s_p_i_module_8c_ac5c85a6a18b2073865149b2c0554ce8d}{CMD\+\_\+\+LEN}}\mbox{]} = \{0x\+AA, 0x\+BB, 0x\+CC\}
\item 
volatile uint8\+\_\+t \mbox{\hyperlink{_s_p_i_module_8c_a6fac7b09ba8c8ef120a188c1ed35dc57}{rx\+\_\+index}} = 0
\item 
SPI\+\_\+\+Handle\+Type\+Def \texorpdfstring{$\ast$}{*} \mbox{\hyperlink{_s_p_i_module_8c_ab03af3f014d42c6b2418347d63fc532e}{hspi}}
\end{DoxyCompactItemize}


\label{doc-define-members}
\Hypertarget{_s_p_i_module_8c_doc-define-members}
\doxysubsection{Documentación de «define»}
\Hypertarget{_s_p_i_module_8c_ac5c85a6a18b2073865149b2c0554ce8d}\index{SPIModule.c@{SPIModule.c}!CMD\_LEN@{CMD\_LEN}}
\index{CMD\_LEN@{CMD\_LEN}!SPIModule.c@{SPIModule.c}}
\doxysubsubsection{\texorpdfstring{CMD\_LEN}{CMD\_LEN}}
{\footnotesize\ttfamily \label{_s_p_i_module_8c_ac5c85a6a18b2073865149b2c0554ce8d} 
\#define CMD\+\_\+\+LEN~3}



Definición en la línea \mbox{\hyperlink{_s_p_i_module_8c_source_l00016}{16}} del archivo \mbox{\hyperlink{_s_p_i_module_8c_source}{SPIModule.\+c}}.

\Hypertarget{_s_p_i_module_8c_a58ae1be1f69cd7b7a0643a2bb826fc7c}\index{SPIModule.c@{SPIModule.c}!SPI\_BUF\_SIZE@{SPI\_BUF\_SIZE}}
\index{SPI\_BUF\_SIZE@{SPI\_BUF\_SIZE}!SPIModule.c@{SPIModule.c}}
\doxysubsubsection{\texorpdfstring{SPI\_BUF\_SIZE}{SPI\_BUF\_SIZE}}
{\footnotesize\ttfamily \label{_s_p_i_module_8c_a58ae1be1f69cd7b7a0643a2bb826fc7c} 
\#define SPI\+\_\+\+BUF\+\_\+\+SIZE~16}



Definición en la línea \mbox{\hyperlink{_s_p_i_module_8c_source_l00014}{14}} del archivo \mbox{\hyperlink{_s_p_i_module_8c_source}{SPIModule.\+c}}.

\Hypertarget{_s_p_i_module_8c_a59d33135764e7772f86c6d0312592d56}\index{SPIModule.c@{SPIModule.c}!SPI\_TRANSMITION\_SIZE@{SPI\_TRANSMITION\_SIZE}}
\index{SPI\_TRANSMITION\_SIZE@{SPI\_TRANSMITION\_SIZE}!SPIModule.c@{SPIModule.c}}
\doxysubsubsection{\texorpdfstring{SPI\_TRANSMITION\_SIZE}{SPI\_TRANSMITION\_SIZE}}
{\footnotesize\ttfamily \label{_s_p_i_module_8c_a59d33135764e7772f86c6d0312592d56} 
\#define SPI\+\_\+\+TRANSMITION\+\_\+\+SIZE~4}



Definición en la línea \mbox{\hyperlink{_s_p_i_module_8c_source_l00015}{15}} del archivo \mbox{\hyperlink{_s_p_i_module_8c_source}{SPIModule.\+c}}.



\label{doc-func-members}
\Hypertarget{_s_p_i_module_8c_doc-func-members}
\doxysubsection{Documentación de funciones}
\Hypertarget{_s_p_i_module_8c_a2762f45ff67d3812619ca1b63c255140}\index{SPIModule.c@{SPIModule.c}!HAL\_SPI\_TxRxCpltCallback@{HAL\_SPI\_TxRxCpltCallback}}
\index{HAL\_SPI\_TxRxCpltCallback@{HAL\_SPI\_TxRxCpltCallback}!SPIModule.c@{SPIModule.c}}
\doxysubsubsection{\texorpdfstring{HAL\_SPI\_TxRxCpltCallback()}{HAL\_SPI\_TxRxCpltCallback()}}
{\footnotesize\ttfamily \label{_s_p_i_module_8c_a2762f45ff67d3812619ca1b63c255140} 
void HAL\+\_\+\+SPI\+\_\+\+Tx\+Rx\+Cplt\+Callback (\begin{DoxyParamCaption}\item[{SPI\+\_\+\+Handle\+Type\+Def \texorpdfstring{$\ast$}{*}}]{\+\_\+hspi}{}\end{DoxyParamCaption})}



Callback de HAL llamado al completar una transacción Tx\+Rx por DMA. 


\begin{DoxyItemize}
\item Busca el delimitador \textquotesingle{};\textquotesingle{} en rx\+DMABuffer para conocer longitud de comando.
\item Construye una respuesta por defecto (ERR\+\_\+\+NO\+\_\+\+COMMAND) si el frame es inválido.
\item Llama a \doxylink{_s_p_i_module_8c_ad1d9e4b748a3033ce47c0453db513e41}{SPI\+\_\+\+Procesar\+Comando()} si hay un payload válido.
\item Copia la respuesta a tx\+DMABuffer para la PRÓ\+XIMA transacción.
\item Re-\/arma la transacción DMA continua con HAL\+\_\+\+SPI\+\_\+\+Transmit\+Receive\+\_\+\+DMA(). 
\end{DoxyItemize}

Definición en la línea \mbox{\hyperlink{_s_p_i_module_8c_source_l00223}{223}} del archivo \mbox{\hyperlink{_s_p_i_module_8c_source}{SPIModule.\+c}}.

Gráfico de llamadas de esta función\+:
% FIG 1
\Hypertarget{_s_p_i_module_8c_aceba80d82f5ac1327eac27d5a8261885}\index{SPIModule.c@{SPIModule.c}!SPI\_Init@{SPI\_Init}}
\index{SPI\_Init@{SPI\_Init}!SPIModule.c@{SPIModule.c}}
\doxysubsubsection{\texorpdfstring{SPI\_Init()}{SPI\_Init()}}
{\footnotesize\ttfamily \label{_s_p_i_module_8c_aceba80d82f5ac1327eac27d5a8261885} 
void SPI\+\_\+\+Init (\begin{DoxyParamCaption}\item[{void \texorpdfstring{$\ast$}{*}}]{hspi}{}\end{DoxyParamCaption})}



Inicializa el módulo SPI esclavo con DMA y deja activa la primera transacción. 


\begin{DoxyItemize}
\item Configura prioridades/enable de IRQ para DMA1 Channel 4/5 (Tx/\+Rx).
\item Limpia buffers RX/\+TX y precarga una respuesta por defecto ({\ttfamily \doxylink{_s_p_i_module_8h_acdb815a404f9450379dae79745e5ccd9a354b001329a9015ee8fa4d11fe98e1fb}{SPI\+\_\+\+RESPONSE\+\_\+\+OK};}).
\item Llama a {\ttfamily HAL\+\_\+\+SPI\+\_\+\+Transmit\+Receive\+\_\+\+DMA()} para iniciar el ciclo continuo DMA (el tamaño de paquete es el configurado en el fuente, p.\+ej. {\ttfamily \doxylink{_s_p_i_module_8c_a59d33135764e7772f86c6d0312592d56}{SPI\+\_\+\+TRANSMITION\+\_\+\+SIZE}}).
\item El parseo y la construcción de \doxylink{_s_p_i_module_8h_acdb815a404f9450379dae79745e5ccd9}{SPI\+\_\+\+Response} se realizan en el callback {\ttfamily \doxylink{_s_p_i_module_8c_a2762f45ff67d3812619ca1b63c255140}{HAL\+\_\+\+SPI\+\_\+\+Tx\+Rx\+Cplt\+Callback}}, invocando \doxylink{_gestor_estados_8c_a44b3bf408355270c64323425c66e7719}{Gestor\+Estados\+\_\+\+Action} según corresponda.
\end{DoxyItemize}


\begin{DoxyParams}[1]{Parámetros}
\mbox{\texttt{in}}  & {\em hspi} & Handler de SPI inicializado por HAL (tipo {\ttfamily SPI\+\_\+\+Handle\+Type\+Def\texorpdfstring{$\ast$}{*}}, p.\+ej. {\ttfamily \&\doxylink{main_8c_ab9da65f935e805137e2eb4e18c5ab224}{hspi2}}).\\
\hline
\end{DoxyParams}
\begin{DoxySeeAlso}{Ver también}
\doxylink{_gestor_estados_8c_a44b3bf408355270c64323425c66e7719}{Gestor\+Estados\+\_\+\+Action} 

\doxylink{_s_p_i_module_8h_abcc4e317bdfcd5f571d62f7ed92facc5}{SPI\+\_\+\+Request} 

\doxylink{_s_p_i_module_8h_acdb815a404f9450379dae79745e5ccd9}{SPI\+\_\+\+Response} 
\end{DoxySeeAlso}


Definición en la línea \mbox{\hyperlink{_s_p_i_module_8c_source_l00257}{257}} del archivo \mbox{\hyperlink{_s_p_i_module_8c_source}{SPIModule.\+c}}.

Gráfico de llamadas a esta función\+:
% FIG 2
\Hypertarget{_s_p_i_module_8c_ad1d9e4b748a3033ce47c0453db513e41}\index{SPIModule.c@{SPIModule.c}!SPI\_ProcesarComando@{SPI\_ProcesarComando}}
\index{SPI\_ProcesarComando@{SPI\_ProcesarComando}!SPIModule.c@{SPIModule.c}}
\doxysubsubsection{\texorpdfstring{SPI\_ProcesarComando()}{SPI\_ProcesarComando()}}
{\footnotesize\ttfamily \label{_s_p_i_module_8c_ad1d9e4b748a3033ce47c0453db513e41} 
void SPI\+\_\+\+Procesar\+Comando (\begin{DoxyParamCaption}\item[{uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{buffer}{, }\item[{int}]{cant\+Bytes}{, }\item[{uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{buffer\+Response}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Procesa un comando recibido por SPI y construye la respuesta. 


\begin{DoxyParams}{Parámetros}
{\em buffer} & Puntero al buffer recibido (sin el \textquotesingle{};\textquotesingle{} final). \\
\hline
{\em cant\+Bytes} & Cantidad de bytes válidos en buffer (antes de \textquotesingle{};\textquotesingle{}). \\
\hline
{\em buffer\+Response} & Puntero a un arreglo destino (mín. 4 bytes) donde se escribe la respuesta en formato \mbox{[}RESP\mbox{]}\mbox{[}\textquotesingle{};\textquotesingle{}\mbox{]}\mbox{[}dato1\mbox{]}\mbox{[}dato2\mbox{]}.\\
\hline
\end{DoxyParams}
\begin{DoxyNote}{Nota}
La respuesta se deja en buffer\+Response; el callback de DMA la copiará a tx\+DMABuffer. 

Para GET\+\_\+\+FREC se empaquetan hasta 2 bytes (valor \texorpdfstring{$<$}{<}= 511 según tu lógica actual). 
\end{DoxyNote}


Definición en la línea \mbox{\hyperlink{_s_p_i_module_8c_source_l00043}{43}} del archivo \mbox{\hyperlink{_s_p_i_module_8c_source}{SPIModule.\+c}}.

Gráfico de llamadas de esta función\+:
% FIG 3
Gráfico de llamadas a esta función\+:
% FIG 4


\label{doc-var-members}
\Hypertarget{_s_p_i_module_8c_doc-var-members}
\doxysubsection{Documentación de variables}
\Hypertarget{_s_p_i_module_8c_ab03af3f014d42c6b2418347d63fc532e}\index{SPIModule.c@{SPIModule.c}!hspi@{hspi}}
\index{hspi@{hspi}!SPIModule.c@{SPIModule.c}}
\doxysubsubsection{\texorpdfstring{hspi}{hspi}}
{\footnotesize\ttfamily \label{_s_p_i_module_8c_ab03af3f014d42c6b2418347d63fc532e} 
SPI\+\_\+\+Handle\+Type\+Def\texorpdfstring{$\ast$}{*} hspi}



Definición en la línea \mbox{\hyperlink{_s_p_i_module_8c_source_l00031}{31}} del archivo \mbox{\hyperlink{_s_p_i_module_8c_source}{SPIModule.\+c}}.

\Hypertarget{_s_p_i_module_8c_a6fac7b09ba8c8ef120a188c1ed35dc57}\index{SPIModule.c@{SPIModule.c}!rx\_index@{rx\_index}}
\index{rx\_index@{rx\_index}!SPIModule.c@{SPIModule.c}}
\doxysubsubsection{\texorpdfstring{rx\_index}{rx\_index}}
{\footnotesize\ttfamily \label{_s_p_i_module_8c_a6fac7b09ba8c8ef120a188c1ed35dc57} 
volatile uint8\+\_\+t rx\+\_\+index = 0}



Definición en la línea \mbox{\hyperlink{_s_p_i_module_8c_source_l00028}{28}} del archivo \mbox{\hyperlink{_s_p_i_module_8c_source}{SPIModule.\+c}}.

\Hypertarget{_s_p_i_module_8c_a0d2daeae9d2a4a1f3a1580552e640ff3}\index{SPIModule.c@{SPIModule.c}!rxBuffer@{rxBuffer}}
\index{rxBuffer@{rxBuffer}!SPIModule.c@{SPIModule.c}}
\doxysubsubsection{\texorpdfstring{rxBuffer}{rxBuffer}}
{\footnotesize\ttfamily \label{_s_p_i_module_8c_a0d2daeae9d2a4a1f3a1580552e640ff3} 
volatile uint8\+\_\+t rx\+Buffer\mbox{[}\mbox{\hyperlink{_s_p_i_module_8c_a58ae1be1f69cd7b7a0643a2bb826fc7c}{SPI\+\_\+\+BUF\+\_\+\+SIZE}}\mbox{]}}



Definición en la línea \mbox{\hyperlink{_s_p_i_module_8c_source_l00023}{23}} del archivo \mbox{\hyperlink{_s_p_i_module_8c_source}{SPIModule.\+c}}.

\Hypertarget{_s_p_i_module_8c_ab3d82dfa3d2a6af7b144935391b4ff34}\index{SPIModule.c@{SPIModule.c}!rxDMABuffer@{rxDMABuffer}}
\index{rxDMABuffer@{rxDMABuffer}!SPIModule.c@{SPIModule.c}}
\doxysubsubsection{\texorpdfstring{rxDMABuffer}{rxDMABuffer}}
{\footnotesize\ttfamily \label{_s_p_i_module_8c_ab3d82dfa3d2a6af7b144935391b4ff34} 
uint8\+\_\+t rx\+DMABuffer\mbox{[}\mbox{\hyperlink{_s_p_i_module_8c_a58ae1be1f69cd7b7a0643a2bb826fc7c}{SPI\+\_\+\+BUF\+\_\+\+SIZE}}\mbox{]}}



Definición en la línea \mbox{\hyperlink{_s_p_i_module_8c_source_l00019}{19}} del archivo \mbox{\hyperlink{_s_p_i_module_8c_source}{SPIModule.\+c}}.

\Hypertarget{_s_p_i_module_8c_a92c8fb020dce18b7572691d5ffdd0f76}\index{SPIModule.c@{SPIModule.c}!rxIndex@{rxIndex}}
\index{rxIndex@{rxIndex}!SPIModule.c@{SPIModule.c}}
\doxysubsubsection{\texorpdfstring{rxIndex}{rxIndex}}
{\footnotesize\ttfamily \label{_s_p_i_module_8c_a92c8fb020dce18b7572691d5ffdd0f76} 
volatile int rx\+Index = 0}



Definición en la línea \mbox{\hyperlink{_s_p_i_module_8c_source_l00024}{24}} del archivo \mbox{\hyperlink{_s_p_i_module_8c_source}{SPIModule.\+c}}.

\Hypertarget{_s_p_i_module_8c_a7f54dbc4c9079015d2acd620d6b4bf82}\index{SPIModule.c@{SPIModule.c}!tx\_buffer@{tx\_buffer}}
\index{tx\_buffer@{tx\_buffer}!SPIModule.c@{SPIModule.c}}
\doxysubsubsection{\texorpdfstring{tx\_buffer}{tx\_buffer}}
{\footnotesize\ttfamily \label{_s_p_i_module_8c_a7f54dbc4c9079015d2acd620d6b4bf82} 
volatile uint8\+\_\+t tx\+\_\+buffer\mbox{[}\mbox{\hyperlink{_s_p_i_module_8c_ac5c85a6a18b2073865149b2c0554ce8d}{CMD\+\_\+\+LEN}}\mbox{]} = \{0x\+AA, 0x\+BB, 0x\+CC\}}



Definición en la línea \mbox{\hyperlink{_s_p_i_module_8c_source_l00027}{27}} del archivo \mbox{\hyperlink{_s_p_i_module_8c_source}{SPIModule.\+c}}.

\Hypertarget{_s_p_i_module_8c_a6f050568ae6cfe8a5b1c4a139e78e66b}\index{SPIModule.c@{SPIModule.c}!txDMABuffer@{txDMABuffer}}
\index{txDMABuffer@{txDMABuffer}!SPIModule.c@{SPIModule.c}}
\doxysubsubsection{\texorpdfstring{txDMABuffer}{txDMABuffer}}
{\footnotesize\ttfamily \label{_s_p_i_module_8c_a6f050568ae6cfe8a5b1c4a139e78e66b} 
uint8\+\_\+t tx\+DMABuffer\mbox{[}\mbox{\hyperlink{_s_p_i_module_8c_a58ae1be1f69cd7b7a0643a2bb826fc7c}{SPI\+\_\+\+BUF\+\_\+\+SIZE}}\mbox{]}}



Definición en la línea \mbox{\hyperlink{_s_p_i_module_8c_source_l00020}{20}} del archivo \mbox{\hyperlink{_s_p_i_module_8c_source}{SPIModule.\+c}}.

